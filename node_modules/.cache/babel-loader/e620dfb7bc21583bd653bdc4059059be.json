{"ast":null,"code":"import _regeneratorRuntime from\"/home/fs/srmswap/oyster-swap/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/home/fs/srmswap/oyster-swap/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _toConsumableArray from\"/home/fs/srmswap/oyster-swap/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _objectSpread from\"/home/fs/srmswap/oyster-swap/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _slicedToArray from\"/home/fs/srmswap/oyster-swap/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useMemo,useRef,useState}from\"react\";import{Button,Popover,Table}from\"antd\";import{AppBar}from\"./../appBar\";import{cache,getMultipleAccounts,MintParser,useCachedPool}from\"../../utils/accounts\";import{convert,getPoolName,STABLE_COINS}from\"../../utils/utils\";import{useConnectionConfig}from\"../../utils/connection\";import{Settings}from\"../settings\";import{SettingOutlined}from\"@ant-design/icons\";import{PoolIcon}from\"../tokenIcon\";import{Market,MARKETS,Orderbook,TOKEN_MINTS}from\"@project-serum/serum\";import{Connection,PublicKey}from\"@solana/web3.js\";import\"./styles.less\";import echarts from\"echarts\";var FlashText=function FlashText(props){var _useState=useState(\"\"),_useState2=_slicedToArray(_useState,2),activeClass=_useState2[0],setActiveClass=_useState2[1];var _useState3=useState(props.val),_useState4=_slicedToArray(_useState3,1),value=_useState4[0];useEffect(function(){if(props.val!==value){setActiveClass(props.val>value?\"flash-positive\":\"flash-negative\");setTimeout(function(){return setActiveClass(\"\");},200);}},[props.text,props.val,value]);return/*#__PURE__*/React.createElement(\"span\",{className:activeClass},props.text);};var INITAL_LIQUIDITY_DATE=new Date(\"2020-10-27\");var REFRESH_INTERVAL=30000;var OrderBookParser=function OrderBookParser(id,acc){var decoded=Orderbook.LAYOUT.decode(acc.data);var details={pubkey:id,account:_objectSpread({},acc),info:decoded};return details;};var getMidPrice=function getMidPrice(marketAddress,mintAddress){var _cache$get,_cache$get2,_cache$get3,_cache$get4;var SERUM_TOKEN=TOKEN_MINTS.find(function(a){return a.address.toBase58()===mintAddress;});if(STABLE_COINS.has((SERUM_TOKEN===null||SERUM_TOKEN===void 0?void 0:SERUM_TOKEN.name)||\"\")){return 1.0;}var marketInfo=cache.get(marketAddress);if(!marketInfo){return 0.0;}var decodedMarket=marketInfo.info;var baseMintDecimals=((_cache$get=cache.get(decodedMarket.baseMint))===null||_cache$get===void 0?void 0:_cache$get.info.decimals)||0;var quoteMintDecimals=((_cache$get2=cache.get(decodedMarket.quoteMint))===null||_cache$get2===void 0?void 0:_cache$get2.info.decimals)||0;var market=new Market(decodedMarket,baseMintDecimals,quoteMintDecimals,undefined,decodedMarket.programId);var bids=(_cache$get3=cache.get(decodedMarket.bids))===null||_cache$get3===void 0?void 0:_cache$get3.info;var asks=(_cache$get4=cache.get(decodedMarket.asks))===null||_cache$get4===void 0?void 0:_cache$get4.info;var bidsBook=new Orderbook(market,bids.accountFlags,bids.slab);var asksBook=new Orderbook(market,asks.accountFlags,asks.slab);var bestBid=bidsBook.getL2(1);var bestAsk=asksBook.getL2(1);if(bestBid.length>0&&bestAsk.length>0){return(bestBid[0][0]+bestAsk[0][0])/2.0;}return 0;};var SRM_USDC_MARKET=new PublicKey(\"CDdR97S8y96v3To93aKvi3nCnjUrbuVSuumw8FLvbVeg\");var SRM_MINT=new PublicKey(\"SRMuApVNdxXokk5GT7XD5cUUgXMBCoAz2LHeuAoKWRt\");export var ChartsView=React.memo(function(){var _useConnectionConfig=useConnectionConfig(),env=_useConnectionConfig.env,endpoint=_useConnectionConfig.endpoint;var _useCachedPool=useCachedPool(),pools=_useCachedPool.pools;var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),dataSource=_useState6[0],setDataSource=_useState6[1];var _useState7=useState(function(){return{liquidity:0,volume:0,fees:0};}),_useState8=_slicedToArray(_useState7,2),totals=_useState8[0],setTotals=_useState8[1];var chartDiv=useRef(null);var echartsRef=useRef(null);var updateCounterRef=useRef(0);// separate connection for market updates\nvar connection=useMemo(function(){return new Connection(endpoint,\"recent\");},[endpoint]);useEffect(function(){if(chartDiv.current){echartsRef.current=echarts.init(chartDiv.current);}return function(){echartsRef.current.dispose();};},[]);// TODO: display user percent in the pool\n// const { ownedPools } = useOwnedPools();\n// TODO: create cache object with layout type, get, query, add\n// Updates total values\nuseEffect(function(){setTotals(dataSource.reduce(function(acc,item){acc.liquidity=acc.liquidity+item.liquidity;acc.volume=acc.volume+item.volume;acc.fees=acc.fees+item.fees;return acc;},{liquidity:0,volume:0,fees:0}));// update chart on data changes only every 5 ticks\nif(echartsRef.current&&updateCounterRef.current%5===0){echartsRef.current.setOption({series:[{name:\"Liquidity\",type:\"treemap\",visibleMin:300,label:{show:true,formatter:\"{b}\"},itemStyle:{normal:{borderColor:\"#000\"}},breadcrumb:{show:false},data:dataSource.map(function(row){return{value:row.liquidity,name:row.name,path:\"Liquidity/\".concat(row.name),data:row};})}]});}if(dataSource.length>0){updateCounterRef.current=updateCounterRef.current+1;}},[dataSource,echartsRef.current]);useEffect(function(){var reverseSerumMarketCache=new Map();var marketsCache=_toConsumableArray(new Set(pools.map(function(p){return p.pubkeys.holdingMints;}).flat()).values()).reduce(function(acc,key){var mintAddress=key.toBase58();var SERUM_TOKEN=TOKEN_MINTS.find(function(a){return a.address.toBase58()===mintAddress;});var marketName=\"\".concat(SERUM_TOKEN===null||SERUM_TOKEN===void 0?void 0:SERUM_TOKEN.name,\"/USDC\");var marketInfo=MARKETS.find(function(m){return m.name===marketName;});if(marketInfo){reverseSerumMarketCache.set(marketInfo.address.toBase58(),mintAddress);acc.set(mintAddress,{marketInfo:marketInfo});}return acc;},new Map());var timer=0;var toQuery=new Set();var accountsToObserve=new Set();var refreshAccounts=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(keys){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:return _context.abrupt(\"return\",getMultipleAccounts(connection,keys,\"single\").then(function(_ref2){var keys=_ref2.keys,array=_ref2.array;return array.map(function(item,index){var address=keys[index];return cache.add(new PublicKey(address),item);});}));case 1:case\"end\":return _context.stop();}}},_callee);}));return function refreshAccounts(_x){return _ref.apply(this,arguments);};}();var updateData=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(){var TODAY;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:TODAY=new Date();_context2.next=3;return refreshAccounts(_toConsumableArray(accountsToObserve.keys()));case 3:setDataSource(pools.filter(function(p){return p.pubkeys.holdingMints&&p.pubkeys.holdingMints.length>1;}).map(function(p,index){var _marketsCache$get,_marketsCache$get2;var mints=(p.pubkeys.holdingMints||[]).map(function(a){return a.toBase58();}).sort();var indexA=mints[0]===p.pubkeys.holdingMints[0].toBase58()?0:1;var indexB=indexA===0?1:0;var accountA=cache.getAccount(p.pubkeys.holdingAccounts[indexA]);var mintA=cache.getMint(mints[0]);var accountB=cache.getAccount(p.pubkeys.holdingAccounts[indexB]);var mintB=cache.getMint(mints[1]);var baseReserveUSD=getMidPrice(((_marketsCache$get=marketsCache.get(mints[0]))===null||_marketsCache$get===void 0?void 0:_marketsCache$get.marketInfo.address.toBase58())||\"\",mints[0])*convert(accountA,mintA);var quoteReserveUSD=getMidPrice(((_marketsCache$get2=marketsCache.get(mints[1]))===null||_marketsCache$get2===void 0?void 0:_marketsCache$get2.marketInfo.address.toBase58())||\"\",mints[1])*convert(accountB,mintB);var srmYield=0;if(mints[0]===SRM_MINT.toBase58()||mints[1]===SRM_MINT.toBase58()){var srmMid=getMidPrice(SRM_USDC_MARKET.toBase58(),SRM_MINT.toBase58());srmYield=100000*srmMid/(baseReserveUSD+quoteReserveUSD)*(365/30);}var poolMint=cache.getMint(p.pubkeys.mint);if(poolMint===null||poolMint===void 0?void 0:poolMint.supply.eqn(0)){return;}var volume=0;var fees=0;var apy=0;if(p.pubkeys.feeAccount){var feeAccount=cache.getAccount(p.pubkeys.feeAccount);if(poolMint&&feeAccount&&feeAccount.info.mint.toBase58()===p.pubkeys.mint.toBase58()){var feeBalance=feeAccount===null||feeAccount===void 0?void 0:feeAccount.info.amount.toNumber();var supply=poolMint===null||poolMint===void 0?void 0:poolMint.supply.toNumber();var ownedPct=feeBalance/supply;var poolOwnerFees=ownedPct*baseReserveUSD+ownedPct*quoteReserveUSD;volume=poolOwnerFees/0.0004;fees=volume*0.003;if(fees!==0){var baseVolume=ownedPct*baseReserveUSD/0.0004;var quoteVolume=ownedPct*quoteReserveUSD/0.0004;// Aproximation not true for all pools we need to fine a better way\nvar daysSinceInception=Math.floor((TODAY.getTime()-INITAL_LIQUIDITY_DATE.getTime())/(24*3600*1000));var apy0=srmYield+parseFloat(baseVolume/daysSinceInception*0.003*356)/baseReserveUSD;var apy1=srmYield+parseFloat(quoteVolume/daysSinceInception*0.003*356)/quoteReserveUSD;apy=Math.max(apy0,apy1);}}}var lpMint=cache.getMint(p.pubkeys.mint);var name=getPoolName(env,p);var link=\"#/?pair=\".concat(name.replace(\"/\",\"-\"));return{key:p.pubkeys.account.toBase58(),id:index,name:name,address:p.pubkeys.mint.toBase58(),link:link,mints:mints,liquidityA:convert(accountA,mintA),liquidityAinUsd:baseReserveUSD,liquidityB:convert(accountB,mintB),liquidityBinUsd:quoteReserveUSD,supply:lpMint&&((lpMint===null||lpMint===void 0?void 0:lpMint.supply.toNumber())/Math.pow(10,(lpMint===null||lpMint===void 0?void 0:lpMint.decimals)||0)).toFixed(9),fees:fees,liquidity:baseReserveUSD+quoteReserveUSD,volume:volume,apy:apy,raw:p};}).filter(function(p){return p;}));timer=window.setTimeout(function(){return updateData();},REFRESH_INTERVAL);case 5:case\"end\":return _context2.stop();}}},_callee2);}));return function updateData(){return _ref3.apply(this,arguments);};}();var subs=[];var initalQuery=/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var allMarkets;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:allMarkets=_toConsumableArray(marketsCache.values()).map(function(m){return m.marketInfo.address.toBase58();});_context3.next=3;return getMultipleAccounts(connection,// only query for markets that are not in cahce\nallMarkets.filter(function(a){return cache.get(a)===undefined;}),\"single\").then(function(_ref5){var keys=_ref5.keys,array=_ref5.array;return array.map(function(item,index){var marketAddress=keys[index];var mintAddress=reverseSerumMarketCache.get(marketAddress);if(mintAddress){var market=marketsCache.get(mintAddress);if(market){var programId=market.marketInfo.programId;var id=market.marketInfo.address;cache.add(id,item,function(id,acc){var decoded=Market.getLayout(programId).decode(acc.data);var details={pubkey:id,account:_objectSpread({},acc),info:decoded};cache.registerParser(details.info.baseMint,MintParser);cache.registerParser(details.info.quoteMint,MintParser);cache.registerParser(details.info.bids,OrderBookParser);cache.registerParser(details.info.asks,OrderBookParser);return details;});}}return item;});});case 3:allMarkets.forEach(function(m){var market=cache.get(m);if(!market){return;}var decoded=market;if(!cache.get(decoded.info.baseMint)){toQuery.add(decoded.info.baseMint.toBase58());}if(!cache.get(decoded.info.baseMint)){toQuery.add(decoded.info.quoteMint.toBase58());}toQuery.add(decoded.info.bids.toBase58());accountsToObserve.add(decoded.info.bids.toBase58());toQuery.add(decoded.info.asks.toBase58());accountsToObserve.add(decoded.info.asks.toBase58());});_context3.next=6;return refreshAccounts(_toConsumableArray(toQuery.keys()));case 6:// start update loop\nupdateData();case 7:case\"end\":return _context3.stop();}}},_callee3);}));return function initalQuery(){return _ref4.apply(this,arguments);};}();initalQuery();return function(){window.clearTimeout(timer);};},[pools]);var formatUSD=new Intl.NumberFormat(\"en-US\",{style:\"currency\",currency:\"USD\"});var formatPct=new Intl.NumberFormat(\"en-US\",{style:\"percent\",minimumFractionDigits:2,maximumFractionDigits:2});var columns=[{title:\"Name\",dataIndex:\"name\",key:\"name\",render:function render(text,record){return{props:{style:{}},children:/*#__PURE__*/React.createElement(\"div\",{style:{display:\"flex\"}},/*#__PURE__*/React.createElement(PoolIcon,{mintA:record.mints[0],mintB:record.mints[1]}),/*#__PURE__*/React.createElement(\"a\",{href:record.link,target:\"_blank\",rel:\"noopener noreferrer\"},text))};}},{title:\"Liquidity\",dataIndex:\"liquidity\",key:\"liquidity\",render:function render(text,record){return{props:{style:{textAlign:\"right\"}},children:/*#__PURE__*/React.createElement(FlashText,{text:formatUSD.format(record.liquidity),val:record.liquidity})};},sorter:function sorter(a,b){return a.liquidity-b.liquidity;},sortOrder:\"descend\"},{title:\"Supply\",dataIndex:\"supply\",key:\"supply\",render:function render(text,record){return{props:{style:{textAlign:\"right\"}},children:/*#__PURE__*/React.createElement(FlashText,{text:text,val:record.supply})};}},{title:\"Volume\",dataIndex:\"volume\",key:\"volume\",render:function render(text,record){return{props:{style:{textAlign:\"right\"}},children:/*#__PURE__*/React.createElement(FlashText,{text:formatUSD.format(record.volume),val:record.volume})};}},{title:\"Fees\",dataIndex:\"fees\",key:\"fees\",render:function render(text,record){return{props:{style:{textAlign:\"right\"}},children:/*#__PURE__*/React.createElement(FlashText,{text:formatUSD.format(record.fees),val:record.fees})};}},{title:\"APY\",dataIndex:\"apy\",key:\"apy\",render:function render(text,record){return{props:{style:{textAlign:\"right\"}},children:formatPct.format(record.apy)};}},{title:\"Address\",dataIndex:\"address\",key:\"address\",render:function render(text){return{props:{style:{fontFamily:\"monospace\"}},children:/*#__PURE__*/React.createElement(\"span\",null,text)};}}];return/*#__PURE__*/React.createElement(React.Fragment,null,/*#__PURE__*/React.createElement(AppBar,{right:/*#__PURE__*/React.createElement(Popover,{placement:\"topRight\",title:\"Settings\",content:/*#__PURE__*/React.createElement(Settings,null),trigger:\"click\"},/*#__PURE__*/React.createElement(Button,{shape:\"circle\",size:\"large\",type:\"text\",icon:/*#__PURE__*/React.createElement(SettingOutlined,null)}))}),/*#__PURE__*/React.createElement(\"div\",{className:\"info-header\"},/*#__PURE__*/React.createElement(\"h1\",null,\"Liquidity: \",formatUSD.format(totals.liquidity)),/*#__PURE__*/React.createElement(\"h1\",null,\"Volume: \",formatUSD.format(totals.volume))),/*#__PURE__*/React.createElement(\"div\",{ref:chartDiv,style:{height:\"250px\",width:\"100%\"}}),/*#__PURE__*/React.createElement(Table,{dataSource:dataSource,columns:columns,size:\"small\",pagination:{pageSize:10}}));});","map":null,"metadata":{},"sourceType":"module"}